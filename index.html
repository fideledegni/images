<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Décor EEIA 2022</title>
    <!-- <link rel="icon" type="image/jpg" href="media/logo.jpg"/> -->

    <!-- Barlow Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Barlow:300,400,500,700&display=swap" />
    <!-- The Nautigal Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=The+Nautigal:300,400,500,700&display=swap" />

    <link rel="stylesheet" href="src/styles/reset.css" />
    <link rel="stylesheet" href="src/styles/main.css" />
  </head>

  <body>
    <header class="hidden-print">
      <noscript>You need to enable JavaScript to run this app.</noscript>
      <script type='module'>
        //import the library to talk to imagemagick
        import * as Magick from 'https://knicknic.github.io/wasm-imagemagick/magickApi.js';

        function base64ToArrayBuffer(base64) {
          const binaryString = window.atob(base64);
          console.log("binaryString:", binaryString);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes.buffer;
        }
    
        const srcImage = document.getElementById('srcImage');
        let rotatedImage = document.getElementById('rotatedImage');

        // Fetch the image to rotate, and call image magick
        let doMagickCall = async function () {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          console.log("srcImage:", srcImage);
          canvas.width = srcImage.width; 
          canvas.height = srcImage.height;
          console.log("srcImage.width:", srcImage.width);
          console.log("srcImage.height:", srcImage.height);
          ctx.drawImage(srcImage, 0, 0);
          const dataURL = canvas.toDataURL("image/png");

          // let count = 0;
          // const t = setInterval(() => {
          //   count++;
          //   console.log("working...", count);
          // }, 1000);
          // let fetchedSourceImage = await fetch("src/images/chateau.JPG");
          // let arrayBuffer = await fetchedSourceImage.arrayBuffer();
          // let sourceBytes = new Uint8Array(arrayBuffer);

          console.log("dataURL:", dataURL);

          let sourceBytes = base64ToArrayBuffer(dataURL.split(",")[0]);
          console.log("sourceBytes:", sourceBytes);

          // calling image magick with one source image, and command to rotate & resize image
          const files = [{ 'name': 'srcFile.png', 'content': sourceBytes }];
          const command = ["convert", "srcFile.png", "-rotate", "90", "-resize", "150%", "out.png"];
          let processedFiles = await Magick.Call(files, command);

          // response can be multiple files (example split)
          // here we know we just have one
          let firstOutputImage = processedFiles[0];
          console.log("firstOutputImage:", firstOutputImage);
          rotatedImage.src = URL.createObjectURL(firstOutputImage['blob']);
          // clearInterval(t);
          console.log("created image " + firstOutputImage['name']);
        };
        doMagickCall();
      </script>
    </header>

    <main>
      <nav>
        Décor EEIA 2022
      </nav>

      <div id="root">
        Test
      </div>

      <br/>
      <p>Source image: </p>
      <!-- <img id="srcImage" src="src/images/chateau.JPG" height="400px"> -->
      <img id="srcImage" src="src/images/voiture.JPG" height="400px">
      <br/>
      <br/>
      <p>Rotated and enlarged image: </p>
      <img id="rotatedImage">
    </main>
  </body>

  <footer>
    <div>
      &copy; Fidèle Degni - Tous droits réservés<br/>
      Juillet 2022
    </div>
  </footer>
</html>